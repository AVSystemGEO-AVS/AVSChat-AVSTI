<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IMPRIMIR</title>
</head>
<body>

<script src="https://fileschat.sfo2.cdn.digitaloceanspaces.com/public/libs/wlclient.js"></script>

<script>
  function getParam(name) {
    try { return new URL(window.location.href).searchParams.get(name); }
    catch (_) { return null; }
  }

  function renderModal() {
    document.body.innerHTML = `
      <div>
        <strong>IMPRIMIR</strong>
        <br><br>

        <button id="btn-hoje">HOJE</button>
        <button id="btn-anteriores">DIAS ANTERIORES</button>

        <div id="box-data" style="display:none; margin-top:12px;">
          <div>DIA ESCOLHIDO (DD/MM/AA)</div>
          <input id="inp-data" placeholder="00/00/00" maxlength="8">
          <div id="msg" style="margin-top:8px;"></div>
          <div style="margin-top:10px;">
            <button id="btn-enviar">ENVIAR</button>
            <button id="btn-cancelar">CANCELAR</button>
          </div>
        </div>

        <div id="box-hoje" style="display:none; margin-top:12px;">
          <div style="margin-top:10px;">
            <button id="btn-confirmar-hoje">ENVIAR</button>
            <button id="btn-cancelar-hoje">CANCELAR</button>
          </div>
        </div>
      </div>
    `;

    const btnHoje = document.getElementById("btn-hoje");
    const btnAnt = document.getElementById("btn-anteriores");

    const boxData = document.getElementById("box-data");
    const inpData = document.getElementById("inp-data");
    const msgEl = document.getElementById("msg");

    const boxHoje = document.getElementById("box-hoje");

    function setMsg(t) { if (msgEl) msgEl.textContent = t || ""; }

    function closeCancel() {
      window.WlExtension.closeModal({ cancelled: true });
    }

    function normalizeDDMMAA(v) {
      let s = String(v || "").replace(/[^\d]/g, "").slice(0, 6);
      if (s.length > 2) s = s.slice(0,2) + "/" + s.slice(2);
      if (s.length > 5) s = s.slice(0,5) + "/" + s.slice(5);
      return s;
    }

    function parseDDMMAA(v) {
      const m = String(v || "").trim().match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
      if (!m) return { ok:false, error:"Use 00/00/00 (DD/MM/AA)." };

      const dd = Number(m[1]);
      const mm = Number(m[2]);
      const aa = Number(m[3]);
      const yyyy = 2000 + aa;

      const d = new Date(yyyy, mm - 1, dd);
      const ok =
        d.getFullYear() === yyyy &&
        d.getMonth() === (mm - 1) &&
        d.getDate() === dd;

      if (!ok) return { ok:false, error:"Data invÃ¡lida." };

      return { ok:true, short:`${m[1]}/${m[2]}/${m[3]}`, full:`${m[1]}/${m[2]}/${yyyy}` };
    }

    inpData.addEventListener("input", () => {
      inpData.value = normalizeDDMMAA(inpData.value);
      setMsg("");
    });

    btnHoje.onclick = () => {
      boxData.style.display = "none";
      boxHoje.style.display = "block";
    };

    btnAnt.onclick = () => {
      boxHoje.style.display = "none";
      boxData.style.display = "block";
      setTimeout(() => inpData.focus(), 10);
    };

    document.getElementById("btn-cancelar").onclick = closeCancel;
    document.getElementById("btn-cancelar-hoje").onclick = closeCancel;

    document.getElementById("btn-confirmar-hoje").onclick = () => {
      window.WlExtension.closeModal({ action: "hoje" });
    };

    document.getElementById("btn-enviar").onclick = () => {
      const p = parseDDMMAA(inpData.value);
      if (!p.ok) {
        setMsg(p.error);
        return;
      }
      window.WlExtension.closeModal({
        action: "anteriores",
        data: p.short,   
        dataFull: p.full 
      });
    };
  }

  function initExtension() {
    window.WlExtension.initialize({
      buttons: {
        "attendance-view": [
          {
            icon_url: "https://img.icons8.com/material-sharp/15/000000/print.png",
            text: "IMPRIMIR",
            callback: (atendimento) => {
              const modalUrl = `@EXTENSION_URL?mode=modal`;

              window.WlExtension.modal({
                title: "IMPRIMIR",
                url: modalUrl,
                maxWidth: "450px",
                height: "280px",
                callback: (ret) => {
                  if (!ret || ret.cancelled) return;

                  if (ret.action === "hoje") {
                    window.WlExtension.alert({ message: "Selecionado: HOJE", variant: "success" });
                  } else if (ret.action === "anteriores") {
                    window.WlExtension.alert({ message: `Selecionado: DIAS ANTERIORES (${ret.data})`, variant: "success" });
                  }
                }
              });
            }
          }
        ]
      }
    });
  }

  if (getParam("mode") === "modal") renderModal();
  else initExtension();
</script>

</body>
</html>
